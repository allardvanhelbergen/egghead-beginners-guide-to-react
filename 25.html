<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/react@16.13.1/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16.13.1/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.8.3/babel.js"></script>
    <title>Al's react tutorial</title>
    <style>
      label {
        display: block;
        margin-top: 2rem;
        font-weight: bold;
      }
      input {
        display: block;
        margin-top: 0.5rem;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
  </body>
  <script type="text/babel">
    function useLocalStorageState(key, defaultValue = "") {
      const [state, setState] = React.useState(
        () => window.localStorage.getItem(key) || defaultValue
      );

      React.useEffect(() => {
        window.localStorage.setItem(key, state);
      }, [key, state]);

      return [state, setState];
    }

    function fetchPokemon(name) {
      const pokemonQuery = `
        query ($name: String) {
          pokemon(name: $name) {
            id
            number
            name
            attacks {
              special{
                name
                type
                damage
              }
            }
          }
        }
      `;

      return window
        .fetch("https://graphql-pokemon.now.sh", {
          method: "POST",
          headers: { "content-type": "application/json;charset=UTF-8" },
          body: JSON.stringify({
            query: pokemonQuery,
            variables: { name }
          })
        })
        .then(r => r.json())
        .then(response => response.data.pokemon);
    }

    function PokemonInfo({ pokemonName }) {
      const [pokemonData, setPokemonData] = React.useState(null);

      React.useEffect(() => {
        if (!pokemonName) return;
        setPokemonData(null);

        fetchPokemon(pokemonName).then(pokemonData =>
          setPokemonData(pokemonData)
        );
      }, [pokemonName]);

      if (!pokemonName) {
        return <p>Please enter a pokemon.</p>;
      }

      if (!pokemonData) {
        return <p>Fetching pokemon...</p>;
      }

      return (
        <>
          <p>Results of {pokemonName}</p>
          <pre>{JSON.stringify(pokemonData, null, 2)}</pre>
        </>
      );
    }

    function App() {
      const [pokemonName, setPokemonName] = useLocalStorageState("pokemonName");

      function handleSubmit(event) {
        event.preventDefault();
        setPokemonName(event.target.elements.pokemonName.value);
      }

      return (
        <>
          <form onSubmit={handleSubmit}>
            <label>
              Pokemon:
              <input
                type="text"
                name="pokemonName"
                defaultValue={pokemonName}
              />
            </label>
            <button type="submit">Find pokemon</button>
          </form>
          <div>
            <PokemonInfo pokemonName={pokemonName} />
          </div>
        </>
      );
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</html>
